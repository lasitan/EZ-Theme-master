name: Deploy Vue app to Server

on:
  # Push to main/master 触发部署
  push:
    branches:
      - main
      - master

  # 支持在 Actions 页面手动触发
  workflow_dispatch:

# GITHUB_TOKEN 的权限：只允许读取内容
permissions:
  contents: read

# 避免并行多次部署，保证线上稳定
concurrency:
  group: "deploy"
  cancel-in-progress: false

jobs:
  # 构建前端并上传构建产物
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          # 不使用缓存，每次全新安装依赖
          cache: ''

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      # 将 dist 目录上传为 Pages artifact
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  # 部署到自有服务器
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:

      # 使用 SSH+scp 将 dist 内容同步到服务器 /www/wwwroot/heixin.pp.ua
      # 需要在仓库 Secrets 中配置：SSH_HOST, SSH_USER, SSH_PRIVATE_KEY
      - name: Checkout (for SSH deploy)
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages

      - name: Extract artifact
        run: |
          mkdir -p dist
          tar -xf artifact.tar -C dist

      - name: Deploy to heixin.pp.ua via SSH (scp)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan "$SSH_HOST" >> ~/.ssh/known_hosts

          # 部署前先停止远端 nginx，避免文件被占用（需要 SSH_USER 有权限）
          ssh "${SSH_USER}@${SSH_HOST}" "systemctl stop nginx" || true

          # 清空目标目录下的旧文件，模拟 rsync --delete 的效果
          ssh "${SSH_USER}@${SSH_HOST}" "rm -rf /www/wwwroot/heixin.pp.ua/*" || true

          # 使用 scp 递归上传 dist 内容到目标目录
          scp -r ./dist/* "${SSH_USER}@${SSH_HOST}:/www/wwwroot/heixin.pp.ua/"

          # 同步完成后再启动 nginx
          ssh "${SSH_USER}@${SSH_HOST}" "systemctl start nginx" || true
